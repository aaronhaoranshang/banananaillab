<script>
  let selectedDate = null;
  let selectedTime = null;
  let allSlots = {};

  const projectDurations = {
    "本甲单色（2.5 hour）": 180,
    "本甲款式（3 hour）": 180,
    "延长单色（3 hour）": 180,
    "延长款式（4+ hour）": 360,
    "卸甲ONLY（30 min）": 30
  };

  const shopCloseHour = 21;

  google.script.run.withSuccessHandler((data) => {
    allSlots = data;
    const availableDates = Object.keys(data);
    if (availableDates.length === 0) {
      document.getElementById("inlineCalendar").innerHTML =
        "⚠️ 暂无可预约日期，请稍后再试";
      return;
    }

    flatpickr("#inlineCalendar", {
      inline: true,
      locale: "zh",
      dateFormat: "Y-m-d",
      enable: availableDates,
      onChange: function (_, dateStr) {
        selectedDate = dateStr;
        loadTimes(dateStr);
      },
    });
  }).getAllAvailable();

  function loadTimes(dateStr) {
    selectedTime = null;
    document.getElementById("bookingForm").style.display = "none";
    document.getElementById("selectedTime").value = "";
    document.getElementById("result").textContent = "";

    const container = document.getElementById("timeContainer");
    container.innerHTML = "";

    const times = allSlots[dateStr] || [];

    if (times.length === 0) {
      container.innerHTML = "这一天没有可预约时间，请选择其他日期。";
      return;
    }

    times.forEach((time) => {
      const btn = document.createElement("button");
      btn.className = "time-btn";
      btn.textContent = time;
      btn.onclick = () => {
        selectedTime = time;
        document.getElementById("selectedTime").value =
          selectedDate + " " + selectedTime;
        document.getElementById("bookingForm").style.display = "flex";
        document.getElementById("result").textContent = "";
        document.getElementById("result").style.color = "";

        // ⚠️ 根据所选时间判断可选项目
        const [hour, minute] = selectedTime.split(":").map(Number);
        const endLimit = new Date();
        endLimit.setHours(shopCloseHour, 0, 0, 0);
        const selectedStart = new Date();
        selectedStart.setHours(hour, minute, 0, 0);

        document.querySelectorAll("#project option").forEach((opt) => {
          const label = opt.textContent;
          const duration = projectDurations[label] || 0;
          const estimatedEnd = new Date(selectedStart.getTime() + duration * 60000);
          if (estimatedEnd > endLimit) {
            opt.disabled = true;
          } else {
            opt.disabled = false;
          }
        });
      };
      container.appendChild(btn);
    });
  }

  function submitBooking() {
    const nickname = document.getElementById("nickname").value;
    const wechat = document.getElementById("wechat").value;
    const email = document.getElementById("email").value;
    const project = document.getElementById("project").value;

    if (!nickname || !wechat || !email || !selectedDate || !selectedTime || !project) {
      alert("请填写所有信息并选择时间和项目");
      return;
    }

    google.script.run.withSuccessHandler((res) => {
      document.getElementById("result").textContent = res.message;
      document.getElementById("result").style.color = res.success ? "green" : "red";

      if (res.success) {
        document.getElementById("bookingForm").reset();
        document.getElementById("bookingForm").style.display = "none";
        document.getElementById("selectedTime").value = "";
      }
    }).bookSlot({
      nickname,
      wechat,
      email,
      date: selectedDate,
      time: selectedTime,
      project: project,
    });
  }
</script>
